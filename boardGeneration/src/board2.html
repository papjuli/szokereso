<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Board2</title>
    <script>


    board = null;
    letters = null;
    words = null;

    sheetRow = -1;

    found_words = [];
    score = 0;

    word = "";

    prevElem = null;
    prevPrevElem = null;

    function mytouchstart(event) {
      touch = event.touches[0];
      elem = document.elementFromPoint(touch.clientX, touch.clientY);
      if (elem.dataset.letter != 1) {
        return;
      }
      prevElem = elem;
      prevPrevElem = null;
      word = elem.innerHTML;
      mark(elem);
      showCurrentGuess();
    }

    function mytouchmove(event) {
      touch = event.touches[0];
      elem = document.elementFromPoint(touch.clientX, touch.clientY);
      if (elem.dataset.letter != 1) {
        return;
      }
      if (elem == prevElem) {
        return;
      }
      if (elem == prevPrevElem) {
        unmark(prevElem);
        word = word.slice(0, word.length - 1);
        showCurrentGuess();
        prevElem = elem;
        prevPrevElem = null;
        return;
      }
      if (isMarked(elem)) {
        return;
      }
      dr = elem.dataset.row - prevElem.dataset.row;
      dc = elem.dataset.col - prevElem.dataset.col;
      d = dr*dr + dc*dc;
      if (d == 0 || d > 2) {
        return;
      }
      word = word + elem.innerHTML;
      showCurrentGuess();
      mark(elem);
      prevPrevElem = prevElem;
      prevElem = elem;
    }

    function mytouchend(event) {
      guessWord();
      word = "";
      showCurrentGuess();
      divs = document.getElementById("board").getElementsByTagName("div");
      for (i=0; i<divs.length; ++i) {
        unmark(divs[i]);
      }
    }

    function guessWord() {
      if (words.indexOf(word) != -1) {
        if (found_words.indexOf(word) == -1) {
          document.getElementById("found").innerHTML += " " + word;
          length = word.length;
          score += (length * length - 5 * length + 10) / 2;
          document.getElementById("score").innerHTML = score;
          found_words.push(word);
        }
      }
    }

    function mark(elem) {
      elem.style.backgroundColor = "red";
    }

    function unmark(elem) {
      elem.style.backgroundColor = "white";
    }

    function isMarked(elem) {
      return elem.style.backgroundColor == "red";
    }

    function showCurrentGuess() {
      document.getElementById("result").innerHTML = word;
    }

    function setLettersFromDataset(event) {
      console.log("Clicked " + event);
      setLetters(JSON.parse(event.target.dataset.json));
      sheetRow = event.target.dataset.sheetRow;
      document.getElementById("boardList").innerHTML = "";
    }

    function setLetters(b) {
      words = b.words;
      letters = b.letters;
      document.getElementById("board").innerHTML = "";
      document.getElementById("board").style.setProperty("--boardSize", b.size);

      for (i=0; i<b.size; ++i) {
        for (j=0; j<b.size; ++j) {
          d = document.createElement("div");
          d.innerHTML = b.letters[i][j];
          d.dataset.row = i;
          d.dataset.col = j;
          d.dataset.letter = 1;
          d.className = "letter";
          d.addEventListener("touchend", mytouchend);
          d.addEventListener("touchstart", mytouchstart);
          d.addEventListener("touchmove", mytouchmove);
          document.getElementById("board").appendChild(d);
        }
      }
    }
</script>
</head>
<style>
    body {
      margin: 40px;
    }

    :root {
      --boardSize: 3;
    }

    .board2 {
      display: grid;
      grid-template-columns: repeat(var(--boardSize), 100px);
      grid-gap: 30px;
    }

    .letter {
      border-style: solid;
      border-color: black;
      border-radius: 10px;
      padding: 10px;
      line-height: 60px;
      text-align: center;
      font-size: 250%;
      text-transform: uppercase;
    }
</style>
<body>

<div class="board2" data-letter=0 id="board">
</div>

<script>
document.body.addEventListener('touchmove', function(event) {
  event.preventDefault();
}, false);
</script>

<div id="result"></div>

<div id="found"></div>

<div id="score">0</div>

<script type="text/javascript">
      function handleClientLoad() {
        // Loads the client library and the auth2 library together for efficiency.
        // Loading the auth2 library is optional here since `gapi.client.init` function will load
        // it if not already loaded. Loading it upfront can save one network request.
        gapi.load('client:auth2', initClient);
      }

      function initClient() {
        // Initialize the client with API key and People API, and initialize OAuth with an
        // OAuth 2.0 client ID and scopes (space delimited string) to request access.
        gapi.client.init({
            discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
            clientId: '544351928107-lnucrgo39ustk9aq28s7hnp9kdto6k5j.apps.googleusercontent.com',
            scope: 'https://www.googleapis.com/auth/spreadsheets'
        }).then(function() {
            profile = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile();
            document.getElementById("whoami").innerHTML = profile.getEmail() + " " + profile.getName();
            loadBoardList();
        });
      }

      function handleSignInClick(event) {
        // Ideally the button should only show up after gapi.client.init finishes, so that this
        // handler won't be called before OAuth is initialized.
        gapi.auth2.getAuthInstance().signIn();
      }

      function handleSignOutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
      }

      function loadBoardList() {
        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: '1u9w_rAWrPBUnmQ_G4TYvnIEDifVQg4HWKhbqvFET2Yk',
          range: 'A1:A9999',
        }).then(function(result) {
            console.log(result);
            rows = result.result.values;
            for (i=0; i<rows.length; ++i) {
              b = document.createElement("button");
              b.innerHTML = "Load board " + (i + 1);
              b.dataset.json = rows[i][0];
              b.dataset.sheetRow = i+1;
              b.addEventListener("click", setLettersFromDataset);
              document.getElementById("boardList").appendChild(b);
            }
        });
      }

      function saveBoardResult() {
        console.log("Saving...");
        profile = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile();
        console.log(profile);
        range = "B" + sheetRow;
        console.log(range);
        gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: '1u9w_rAWrPBUnmQ_G4TYvnIEDifVQg4HWKhbqvFET2Yk',
          range: range,
          valueInputOption: "RAW",
          resource: {
            values: [
              [profile.getEmail(), profile.getName(), score, found_words.join()],
            ],
          }
        }).then(function(err, result) {
          if(err) {
            // Handle error
            console.log(err);
          } else {
            console.log('%d cells updated.', result.updatedCells);
          }
        });
      }
    </script>
<script async defer src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>
    <button id="signin-button" onclick="handleSignInClick()">Sign In</button>
    <button id="signout-button" onclick="handleSignOutClick()">Sign Out</button>

<div id="whoami"></div>

<div id="boardList"></div>
<button onclick="saveBoardResult()">Save</button>

</body>
</html>